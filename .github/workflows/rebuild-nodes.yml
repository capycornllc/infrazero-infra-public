name: rebuild-nodes

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.s3_access_key_id }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.s3_secret_access_key }}
      AWS_DEFAULT_REGION: ${{ secrets.s3_region }}
      S3_REGION: ${{ secrets.s3_region }}
      CLOUD_REGION: ${{ secrets.cloud_region }}
      S3_ENDPOINT: ${{ secrets.s3_endpoint }}
      INFRA_STATE_BUCKET: ${{ secrets.infra_state_bucket }}
      OPS_SSH_KEYS_JSON: ${{ secrets.OPS_SSH_KEYS_JSON }}
      HCLOUD_TOKEN: ${{ secrets.hetzner_cloud_token }}
      TF_VAR_hcloud_token: ${{ secrets.hetzner_cloud_token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Read config values
        run: |
          python - <<'PY'
          import os
          import yaml
          from pathlib import Path

          cfg = yaml.safe_load(Path("config/infra.yaml").read_text()) or {}
          bootstrap = cfg.get("bootstrap", {})

          env_lines = [
              f"BOOTSTRAP_PRESIGN_EXPIRY={bootstrap.get('presign_expiry_seconds', 3600)}",
          ]
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as fh:
              fh.write("\n".join(env_lines) + "\n")
          PY


      - name: Normalize S3 endpoint
        run: |
          if [ -z "${S3_ENDPOINT}" ]; then
            echo "S3_ENDPOINT is required" >&2
            exit 1
          fi
          if [[ "${S3_ENDPOINT}" != http://* && "${S3_ENDPOINT}" != https://* ]]; then
            echo "S3_ENDPOINT=https://${S3_ENDPOINT}" >> "$GITHUB_ENV"
          fi

      - name: Validate config
        run: python scripts/validate-config.py --config config/infra.yaml --schema config/schema.json

      - name: Package and upload bootstraps
        run: |
          set -euo pipefail
          mkdir -p build/bootstrap
          chmod +x bootstrap/*.sh
          for role in bastion egress node1 node2 db; do
            tar --zstd -cf "build/bootstrap/${role}.tar.zst" -C bootstrap common.sh "${role}.sh"
            sha=$(sha256sum "build/bootstrap/${role}.tar.zst" | awk '{print $1}')
            echo "$sha" > "build/bootstrap/${role}.sha256"

            aws --endpoint-url "$S3_ENDPOINT" s3 cp "build/bootstrap/${role}.tar.zst" "s3://$INFRA_STATE_BUCKET/bootstrap/${role}.tar.zst"
            url=$(aws --endpoint-url "$S3_ENDPOINT" s3 presign "s3://$INFRA_STATE_BUCKET/bootstrap/${role}.tar.zst" --expires-in "$BOOTSTRAP_PRESIGN_EXPIRY")
            echo "$url" > "build/bootstrap/${role}.url"
          done

          manifest='{}'
          for role in bastion egress node1 node2 db; do
            sha=$(cat "build/bootstrap/${role}.sha256")
            url=$(cat "build/bootstrap/${role}.url")
            manifest=$(jq -c --arg role "$role" --arg url "$url" --arg sha "$sha" '. + {($role): {url: $url, sha256: $sha}}' <<<"$manifest")
          done
          echo "$manifest" | jq '.' > build/bootstrap_artifacts.json

      - name: Render backend + tfvars
        run: |
          python scripts/render-backend.py --config config/infra.yaml --output tofu/backend.hcl
          python scripts/render-config.py --config config/infra.yaml --output tofu/tofu.tfvars.json --bootstrap-artifacts build/bootstrap_artifacts.json

      - name: Init OpenTofu
        run: tofu -chdir=tofu init -backend-config=backend.hcl

      - name: Replace node1 + node2
        run: tofu -chdir=tofu apply -auto-approve -var-file=tofu.tfvars.json -replace=hcloud_server.node1 -replace=hcloud_server.node2 -replace=hcloud_server_network.node1 -replace=hcloud_server_network.node2
